<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸš— Ù†Ø¸Ø§Ù… Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø°ÙƒÙŠ | Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø­ÙŠØ©</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb; --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --dark: #1e293b; --light: #f8fafc; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        body { font-family: 'Cairo', sans-serif; background: #f1f5f9; color: var(--dark); overflow-x: hidden; }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .main-header {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white; padding: 1.5rem; border-radius: 0 0 20px 20px; margin-bottom: 2rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); position: relative; overflow: hidden;
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 2; }
        .logo-box { 
            width: 50px; height: 50px; background: rgba(255,255,255,0.1); border-radius: 12px;
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem; backdrop-filter: blur(5px);
        }
        .status-badge {
            background: rgba(16, 185, 129, 0.2); color: #34d399; padding: 0.5rem 1rem;
            border-radius: 50px; font-weight: 600; display: flex; align-items: center; gap: 8px;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        .pulse { width: 10px; height: 10px; background: #34d399; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(52, 211, 153, 0); } 100% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0); } }

        /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…ØµØ§Ø¯Ø± */
        .sources-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; padding: 0 1rem; margin-bottom: 2rem; }
        .source-card {
            background: white; border-radius: 16px; padding: 1.5rem; text-align: center;
            transition: all 0.3s ease; border: 2px solid transparent; opacity: 0.6; filter: grayscale(80%);
            box-shadow: var(--shadow); position: relative; overflow: hidden;
        }
        .source-card.active { opacity: 1; filter: grayscale(0%); transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        
        .source-card.gps.active { border-color: var(--success); }
        .source-card.wifi.active { border-color: var(--primary); }
        .source-card.tower.active { border-color: var(--warning); }

        .source-icon {
            width: 60px; height: 60px; margin: 0 auto 1rem; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
            background: var(--light); color: var(--dark); transition: all 0.3s;
        }
        .source-card.gps.active .source-icon { background: #dcfce7; color: var(--success); }
        .source-card.wifi.active .source-icon { background: #dbeafe; color: var(--primary); }
        .source-card.tower.active .source-icon { background: #fef3c7; color: var(--warning); }

        .stat-row { display: flex; justify-content: space-around; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #f1f5f9; }
        .stat-item h4 { font-size: 0.8rem; color: #64748b; margin: 0; }
        .stat-item p { font-size: 1.1rem; font-weight: 700; margin: 0; }

        /* Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
        .map-container { padding: 0 1rem; margin-bottom: 2rem; }
        .map-box { 
            height: 60vh; border-radius: 16px; overflow: hidden; box-shadow: var(--shadow); 
            border: 4px solid white; position: relative;
        }
        #map { height: 100%; width: 100%; }

        /* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø³ÙÙ„ÙŠØ© */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; padding: 0 1rem; margin-bottom: 2rem; }
        .mini-stat { background: white; padding: 1rem; border-radius: 12px; text-align: center; box-shadow: var(--shadow); }
        .mini-stat i { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .mini-stat .val { font-size: 1.5rem; font-weight: 800; display: block; }
        .mini-stat .lbl { font-size: 0.8rem; color: #64748b; }

        /* Ø§Ù„ÙÙˆØªØ± ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± */
        .controls { padding: 0 1rem 2rem; display: flex; gap: 1rem; flex-wrap: wrap; }
        .btn-custom { 
            flex: 1; padding: 1rem; border: none; border-radius: 12px; font-weight: 700; 
            display: flex; align-items: center; justify-content: center; gap: 10px; 
            transition: transform 0.2s; cursor: pointer; text-decoration: none;
        }
        .btn-google { background: white; color: var(--dark); box-shadow: var(--shadow); }
        .btn-reset { background: #fee2e2; color: var(--danger); }
        .btn-custom:hover { transform: translateY(-2px); }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #loader {
            position: fixed; inset: 0; background: white; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s;
        }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù‚Ù…Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ...</p>
    </div>

    <header class="main-header">
        <div class="header-content">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div class="logo-box"><i class="fas fa-satellite-dish"></i></div>
                <div>
                    <h1 style="font-size: 1.4rem; margin: 0;">Ù†Ø¸Ø§Ù… Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø°ÙƒÙŠ</h1>
                    <small style="opacity: 0.8;">V52 - Realtime Tracking</small>
                </div>
            </div>
            <div class="status-badge">
                <div class="pulse"></div>
                <span id="connStatus">Ù…ØªØµÙ„</span>
            </div>
        </div>
    </header>

    <div class="sources-grid">
        <div id="card-gps" class="source-card gps">
            <div class="source-icon"><i class="fas fa-satellite"></i></div>
            <h3>GPS Satellite</h3>
            <p style="font-size: 0.9rem; color: #64748b;">Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</p>
            <div class="stat-row">
                <div class="stat-item">
                    <h4>Ø§Ù„Ø£Ù‚Ù…Ø§Ø±</h4>
                    <p id="satCount">--</p>
                </div>
                <div class="stat-item">
                    <h4>Ø§Ù„Ø¯Ù‚Ø©</h4>
                    <p id="gpsAcc">--</p>
                </div>
            </div>
        </div>

        <div id="card-wifi" class="source-card wifi">
            <div class="source-icon"><i class="fas fa-wifi"></i></div>
            <h3>WiFi Locator</h3>
            <p style="font-size: 0.9rem; color: #64748b;">Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</p>
            <div class="stat-row">
                <div class="stat-item">
                    <h4>Ø§Ù„Ø´Ø¨ÙƒØ§Øª</h4>
                    <p id="wifiCount">--</p>
                </div>
                <div class="stat-item">
                    <h4>Ø§Ù„Ø¥Ø´Ø§Ø±Ø©</h4>
                    <p id="wifiSignal">--</p>
                </div>
            </div>
        </div>

        <div id="card-tower" class="source-card tower">
            <div class="source-icon"><i class="fas fa-broadcast-tower"></i></div>
            <h3>Cell Tower</h3>
            <p style="font-size: 0.9rem; color: #64748b;">Ù…ØµØ¯Ø± Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</p>
            <div class="stat-row">
                <div class="stat-item">
                    <h4>Ø§Ù„Ø£Ø¨Ø±Ø§Ø¬</h4>
                    <p>1</p>
                </div>
                <div class="stat-item">
                    <h4>Ø§Ù„Ø¬ÙˆØ¯Ø©</h4>
                    <p id="towerQuality">--</p>
                </div>
            </div>
        </div>
    </div>

    <div class="map-container">
        <div class="map-box">
            <div id="map"></div>
        </div>
        <div style="text-align: center; margin-top: 10px; font-size: 0.9rem; color: #64748b;">
            <i class="fas fa-clock"></i> Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="lastUpdate">--:--:--</span>
        </div>
    </div>

    <div class="stats-grid">
        <div class="mini-stat">
            <i class="fas fa-tachometer-alt text-primary"></i>
            <span class="val" id="speedVal">0</span>
            <span class="lbl">Ø§Ù„Ø³Ø±Ø¹Ø© (ÙƒÙ…/Ø³)</span>
        </div>
        <div class="mini-stat">
            <i class="fas fa-bullseye text-danger"></i>
            <span class="val" id="accVal">--</span>
            <span class="lbl">Ø§Ù„Ø¯Ù‚Ø© (Ù…ØªØ±)</span>
        </div>
        <div class="mini-stat">
            <i class="fas fa-route text-success"></i>
            <span class="val" id="distanceVal">0.0</span>
            <span class="lbl">Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)</span>
        </div>
    </div>

    <div class="controls">
        <a id="googleBtn" href="#" target="_blank" class="btn-custom btn-google">
            <i class="fab fa-google"></i> Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„
        </a>
        <button onclick="resetTrip()" class="btn-custom btn-reset">
            <i class="fas fa-redo"></i> ØªØµÙÙŠØ± Ø§Ù„Ø±Ø­Ù„Ø©
        </button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ğŸ›‘ğŸ›‘ Ø±Ø§Ø¨Ø· Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (ØªØ£ÙƒØ¯ Ù…Ù†Ù‡) ğŸ›‘ğŸ›‘
        const FIREBASE_URL = "https://gps-tracker-534ae-default-rtdb.firebaseio.com/gps.json";

        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        let map, marker, circle;
        let lastLat = 0, lastLng = 0;
        let totalDistance = 0;
        let firstLoad = true;

        // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
            }, 1500);
        });

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        function initMap() {
            map = L.map('map').setView([33.3152, 44.3661], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);

            // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©
            const carIcon = L.divIcon({
                html: '<div style="font-size: 30px; color: #2563eb; filter: drop-shadow(0 3px 5px rgba(0,0,0,0.3));"><i class="fas fa-car-side"></i></div>',
                className: 'custom-car-icon',
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });

            marker = L.marker([33.3152, 44.3661], {icon: carIcon}).addTo(map);
            circle = L.circle([33.3152, 44.3661], {radius: 50, color: '#2563eb', fillOpacity: 0.1}).addTo(map);
            
            // Ø¨Ø¯Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            setInterval(fetchData, 3000);
            fetchData();
        }

        // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© (Haversine Formula)
        function calcDistance(lat1, lon1, lat2, lon2) {
            if (lat1 === 0 || lat2 === 0) return 0;
            const R = 6371; // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø£Ø±Ø¶ ÙƒÙ…
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±
        }

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³
        async function fetchData() {
            try {
                const response = await fetch(FIREBASE_URL);
                const data = await response.json();

                if (data && data.lat && data.lng) {
                    const lat = parseFloat(data.lat);
                    const lng = parseFloat(data.lng);
                    const acc = parseFloat(data.accuracy) || 20;
                    const speed = Math.round(data.speed || 0);
                    const type = data.type || "Unknown";
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                    const newPos = new L.LatLng(lat, lng);
                    marker.setLatLng(newPos);
                    circle.setLatLng(newPos);
                    circle.setRadius(acc);
                    
                    if (firstLoad) {
                        map.setView(newPos, 16);
                        firstLoad = false;
                        lastLat = lat; lastLng = lng;
                    } else {
                        map.panTo(newPos);
                    }

                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ© (ÙÙ‚Ø· Ø¥Ø°Ø§ ØªØ­Ø±ÙƒØª Ø£ÙƒØ«Ø± Ù…Ù† 20 Ù…ØªØ± Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø¶Ø¬ÙŠØ¬)
                    const dist = calcDistance(lastLat, lastLng, lat, lng);
                    if (dist > 0.02) { // 20 Ù…ØªØ±
                        totalDistance += dist;
                        lastLat = lat; lastLng = lng;
                    }

                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù…
                    updateUI(type, acc, speed, totalDistance);
                    
                    // ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø¬ÙˆØ¬Ù„
                    document.getElementById('googleBtn').href = `https://www.google.com/maps?q=${lat},${lng}`;
                    
                    // ÙˆÙ…ÙŠØ¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                    const statusDot = document.querySelector('.pulse');
                    statusDot.style.animation = 'none';
                    statusDot.offsetHeight; /* trigger reflow */
                    statusDot.style.animation = 'pulse 2s infinite';
                }
            } catch (err) {
                console.error("Error fetching data:", err);
                document.getElementById('connStatus').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...";
                document.getElementById('connStatus').style.color = "orange";
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
        function updateUI(type, acc, speed, dist) {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
            document.querySelectorAll('.source-card').forEach(el => el.classList.remove('active'));
            
            // ØªÙ†Ø´ÙŠØ· Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
            if (type.includes("GPS")) {
                const card = document.getElementById('card-gps');
                card.classList.add('active');
                circle.setStyle({color: '#10b981', fillColor: '#10b981'});
                // ØªÙ‚Ø¯ÙŠØ± Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ù…Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ù‚Ø©
                document.getElementById('satCount').innerText = acc < 5 ? "12+" : (acc < 10 ? "8-10" : "4-6");
                document.getElementById('gpsAcc').innerText = acc + "m";
            } 
            else if (type.includes("WiFi")) {
                const card = document.getElementById('card-wifi');
                card.classList.add('active');
                circle.setStyle({color: '#2563eb', fillColor: '#2563eb'});
                // Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„ÙˆØ§ÙŠ ÙØ§ÙŠ (ÙŠÙ…ÙƒÙ† Ø¬Ù„Ø¨Ù‡Ø§ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ù„Ø§Ø­Ù‚Ø§Ù‹)
                document.getElementById('wifiCount').innerText = "3+";
                document.getElementById('wifiSignal').innerText = "Good";
            } 
            else {
                const card = document.getElementById('card-tower');
                card.classList.add('active');
                circle.setStyle({color: '#f59e0b', fillColor: '#f59e0b'});
                document.getElementById('towerQuality').innerText = acc < 500 ? "4G LTE" : "3G/2G";
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø³ÙÙ„ÙŠØ©
            document.getElementById('speedVal').innerText = speed;
            document.getElementById('accVal').innerText = acc;
            document.getElementById('distanceVal').innerText = dist.toFixed(2);
            
            // Ø§Ù„ÙˆÙ‚Øª
            const now = new Date();
            document.getElementById('lastUpdate').innerText = now.toLocaleTimeString();
        }

        function resetTrip() {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø­Ù„Ø©ØŸ")) {
                totalDistance = 0;
                document.getElementById('distanceVal').innerText = "0.0";
            }
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        initMap();

    </script>
</body>
</html>
